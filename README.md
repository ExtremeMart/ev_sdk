# EV_SDK

### æœ¬æ–‡æ¡£æœ€æ–°ç‰ˆè¯·ç§»æ­¥ğŸ‘‰https://github.com/ExtremeMart/dev-docs

## è¯´æ˜
### EV_SDKçš„ç›®æ ‡
å¼€å‘è€…ä¸“æ³¨äºç®—æ³•å¼€å‘åŠä¼˜åŒ–ï¼Œæœ€å°åŒ–ä¸šåŠ¡å±‚ç¼–ç ï¼Œå³å¯å¿«é€Ÿéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå…±åŒæ‰“é€ å•†ç”¨çº§é«˜è´¨é‡ç®—æ³•ã€‚
### æå¸‚å¹³å°åšäº†å“ªäº›
1. ç»Ÿä¸€å®šä¹‰ç®—æ³•æ¥å£ï¼šé’ˆå¯¹ä¸‡åƒè§†é¢‘å’Œå›¾ç‰‡åˆ†æç®—æ³•ï¼ŒæŠ½è±¡å‡ºæ¥å£ï¼Œå®šä¹‰åœ¨`include`ç›®å½•ä¸‹çš„`ji.h`æ–‡ä»¶ä¸­
2. æä¾›å·¥å…·åŒ…ï¼šæ¯”å¦‚ç®—æ³•æˆæƒï¼ˆå¿…é¡»å®ç°ï¼‰ã€æ¨¡å‹åŠ å¯†ï¼Œåœ¨`3rd`ç›®å½•ä¸‹
3. åº”ç”¨å±‚æœåŠ¡ï¼šæ­¤æ¨¡å—ä¸åœ¨ev_sdkä¸­ï¼Œæ¯”å¦‚è§†é¢‘å¤„ç†æœåŠ¡ã€ç®—æ³•å¯¹å¤–é€šè®¯çš„httpæœåŠ¡ç­‰

### å¼€å‘è€…éœ€è¦åšä»€ä¹ˆ
1. æ¨¡å‹çš„è®­ç»ƒå’Œè°ƒä¼˜
2. å®ç°`ji.h`çº¦å®šçš„æ¥å£ï¼ŒåŒæ—¶åŒ…æ‹¬æˆæƒã€æ”¯æŒåˆ†æåŒºåŸŸç­‰åŠŸèƒ½
3. å®ç°çº¦å®šçš„è¾“å…¥è¾“å‡º
4. å…¶ä»–åé¢æ–‡æ¡£æåˆ°çš„åŠŸèƒ½

## ç›®å½•

### ä»£ç ç›®å½•ç»“æ„

```
ev_sdk
|-- 3rd             # ç¬¬ä¸‰æ–¹æºç æˆ–åº“ç›®å½•ï¼Œå‘å¸ƒæ—¶è¯·åˆ é™¤
|   |-- wkt_parser          # é’ˆå¯¹ä½¿ç”¨WKTæ ¼å¼ç¼–å†™çš„å­—ç¬¦ä¸²çš„è§£æå™¨
|   |-- cJSON               # cç‰ˆjsonåº“ï¼Œç®€å•æ˜“ç”¨
|   |-- ev_encrypt_module   # æ¨¡å‹åŠ å¯†åº“åŠç›¸å…³å·¥å…·
|   |-- darknet             # ç¤ºä¾‹é¡¹ç›®ä¾èµ–çš„åº“
|   `-- license             # SDKæˆæƒåº“åŠç›¸å…³å·¥å…·
|-- CMakeLists.txt          # æœ¬é¡¹ç›®çš„cmakeæ„å»ºæ–‡ä»¶
|-- README.md       # æœ¬è¯´æ˜æ–‡ä»¶
|-- model           # æ¨¡å‹æ•°æ®å­˜æ”¾æ–‡ä»¶å¤¹
|-- config          # ç¨‹åºé…ç½®ç›®å½•
|   |-- README.md   # algo_config.jsonæ–‡ä»¶å„ä¸ªå‚æ•°çš„è¯´æ˜å’Œé…ç½®æ–¹æ³•
|   `-- algo_config.json    # ç¨‹åºé…ç½®æ–‡ä»¶
|-- doc
|-- include         # åº“å¤´æ–‡ä»¶ç›®å½•
|   `-- ji.h        # libji.soçš„å¤´æ–‡ä»¶ï¼Œç†è®ºä¸Šä»…æœ‰å”¯ä¸€ä¸€ä¸ªå¤´æ–‡ä»¶
|-- lib             # æœ¬é¡¹ç›®ç¼–è¯‘å¹¶å®‰è£…ä¹‹åï¼Œé»˜è®¤ä¼šå°†ä¾èµ–çš„åº“æ”¾åœ¨è¯¥ç›®å½•ï¼ŒåŒ…æ‹¬libji.so
|-- src             # å®ç°ji.cppçš„ä»£ç 
`-- test            # é’ˆå¯¹ji.hä¸­æ‰€å®šä¹‰æ¥å£çš„æµ‹è¯•ä»£ç ï¼Œè¯·å‹¿ä¿®æ”¹ï¼ï¼ï¼
```
## ä½¿ç”¨ç¤ºä¾‹
ä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªä½¿ç”¨`darknet`å®ç°çš„å›¾åƒæ£€æµ‹å™¨ï¼Œå¹¶å°†å…¶ä½¿ç”¨`EV_SDK`è§„èŒƒè¿›è¡Œå°è£…ï¼Œéœ€è¦å®ç°çš„ä¸šåŠ¡é€»è¾‘æ˜¯å½“æ£€æµ‹åˆ°**ç‹—**æ—¶ï¼Œéœ€è¦è¿”å›ç›¸å…³çš„æŠ¥è­¦ä¿¡æ¯ã€‚ä½¿ç”¨å¦‚ä¸‹æ­¥éª¤å°è¯•ç¼–è¯‘å’Œæµ‹è¯•è¯¥é¡¹ç›®ï¼š

#### ä¸‹è½½`EV_SDK`

```shell
git clone https://github.com/ExtremeMart/dev-docs
mv dev-docs /usr/local/ev_sdk
```

#### ç¼–è¯‘

ç¼–è¯‘å’Œå®‰è£…`libji.so`ï¼š

```shell
mkdir -p /usr/local/ev_sdk/build
cd /usr/local/ev_sdk/build
cmake ..
make install
```

#### æµ‹è¯•ç¤ºä¾‹ç¨‹åºå’Œæ¥å£è§„èŒƒ

æ‰§è¡Œå®Œæˆä¹‹åï¼Œ`/usr/local/ev_sdk/lib`ä¸‹å°†ç”Ÿæˆ`libji.so`å’Œç›¸å…³çš„ä¾èµ–åº“ï¼Œä»¥åŠ`/usr/local/ev_sdk/bin/`ä¸‹çš„æµ‹è¯•ç¨‹åº`test-ji-api`ã€‚

1. è¦ä½¿ç”¨`/usr/local/ev_sdk/bin/test-ji-api`æµ‹è¯•`EV_SDK`çš„æ¥å£ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆæˆæƒæ‰€ä½¿ç”¨çš„å‚è€ƒç `reference.txt`ï¼Œå¹¶ä½¿ç”¨ç§é’¥å¯¹å…¶è¿›è¡ŒåŠ å¯†åé‡æ–°ç”Ÿæˆæˆæƒæ–‡ä»¶`license.txt`

   ```shell
   # ç”Ÿæˆå…¬ç§é’¥ä»¥åŠå…¬é’¥å¯¹åº”çš„å¤´æ–‡ä»¶
   bash /usr/local/ev_sdk/3rd/license/bin/oneKeyAuth.sh
   # ç”Ÿæˆç¡¬ä»¶å‚è€ƒç æ–‡ä»¶å’Œæˆæƒæ–‡ä»¶
   bash /usr/local/ev_sdk/3rd/license/bin/oneKeyTest.sh
   ```
   
2. ä½¿ç”¨`test-ji-api`æµ‹è¯•`ji_calc_frame`æ¥å£ï¼Œæµ‹è¯•æ·»åŠ äº†ä¸€ä¸ª`ROI`å‚æ•°

   ```shell
   /usr/local/ev_sdk/bin/test-ji-api -f ji_calc_frame -i /usr/local/ev_sdk/data/dog.jpg -o /tmp/output.jpg -l /usr/local/ev_sdk/authorization/license.txt -a '{"roi":["POLYGON((0.2 0.2,0.6 0.1,0.8 0.7,0.4 0.9,0.1 0.8,0.2 0.25))"]}'
   ```

   è¾“å‡ºå†…å®¹æ ·ä¾‹ï¼š

   ```shell
    code: 0
    json: {
    "alert_flag":   1,
    "dogs": [{
            "x": 129,
            "y": 186,
            "width": 369,
            "height": 516,
            "confidence":   0.566474
        }]
    }
   ```

## ä½¿ç”¨`EV_SDK`å¿«é€Ÿå°è£…ç®—æ³•

å‡è®¾é¡¹ç›®éœ€è¦æ£€æµ‹è¾“å…¥å›¾åƒä¸­æ˜¯å¦æœ‰**ç‹—**ï¼Œå¦‚æœæ£€æµ‹åˆ°**ç‹—**ï¼Œå°±éœ€è¦è¾“å‡ºæŠ¥è­¦ä¿¡æ¯ï¼Œä»¥ä¸‹ç¤ºä¾‹å¼€å‘ç®—æ³•ä¸ä½¿ç”¨`EV_SDK`è¿›è¡Œå°è£…çš„æµç¨‹

#### å®ç°è‡ªå·±çš„æ¨¡å‹

å‡è®¾æˆ‘ä»¬ä½¿ç”¨`darknet`å¼€å‘äº†é’ˆå¯¹**ç‹—**çš„æ£€æµ‹ç®—æ³•ï¼Œç¨‹åºéœ€è¦åœ¨æ£€æµ‹åˆ°ç‹—æ—¶è¾“å‡ºæŠ¥è­¦ä¿¡æ¯ã€‚

#### ä¸‹è½½`EV_SDK`

```shell
git clone https://github.com/ExtremeMart/dev-docs
mv dev-docs /usr/local/ev_sdk
```

#### ç”ŸæˆæˆæƒåŠŸèƒ½æ‰€ä¾èµ–çš„æ–‡ä»¶

1. ä½¿ç”¨`EV_SDK`æä¾›çš„å·¥å…·ä¸€é”®ç”Ÿæˆå…¬é’¥å’Œç§é’¥ã€ä»¥åŠå…¬é’¥å¯¹åº”çš„å¤´æ–‡ä»¶`pubKey.hpp`

   ```shell
   bash /usr/local/ev_sdk/3rd/license/bin/oneKeyAuth.sh
   ```
   
   æ‰§è¡ŒæˆåŠŸåå°†åœ¨`/usr/local/ev_sdk`ä¸‹ç”Ÿæˆå…¬é’¥`authorization/pubKey.perm`å’Œç§é’¥`authorization/privateKey.pem`ï¼Œä»¥åŠå¤´æ–‡ä»¶`include/pubKey.hpp`ï¼›

3. åœ¨`ji_init(int argc, char **argv)`çš„æ¥å£å®ç°ä¸­ï¼Œæ·»åŠ æ ¡éªŒæˆæƒæ–‡ä»¶çš„åŠŸèƒ½ã€‚

   > **æ³¨ï¼šè¿™éƒ¨åˆ†ä»£ç åœ¨ç¤ºä¾‹ä»£ç `ji.cpp`ä¸­å·²ç»å®ç°ï¼Œå¯ä»¥æ— éœ€å˜åŠ¨ï¼Œç›´æ¥ä½¿ç”¨ã€‚**
   
   ```c++
   // ä½¿ç”¨å…¬é’¥æ ¡éªŒæˆæƒä¿¡æ¯
   int ret = ji_check_license(pubKey, license, url, activation, timestamp, qps, version);
   return ret == EV_SUCCESS ? JISDK_RET_SUCCEED : JISDK_RET_UNAUTHORIZED;
   ```

> æ›´å¤šæˆæƒåŠŸèƒ½çš„åŸç†ï¼Œè¯·å‚è€ƒ[ç®—æ³•æˆæƒ](doc/Authorization.md)ã€‚

#### æ·»åŠ æ¨¡å‹åŠ å¯†åŠŸèƒ½

1. ä½¿ç”¨`EV_SDK`æä¾›çš„å·¥å…·åŠ å¯†æ¨¡å‹ï¼Œå¹¶ç”Ÿæˆ`C++`å¤´æ–‡ä»¶ï¼Œ**è¿™é‡Œä»…ä»…ç¤ºä¾‹åŠ å¯†`yolov3-tiny.cfg`æ–‡ä»¶ï¼Œè¯·æ ¹æ®å®é™…éœ€è¦ï¼Œå¯¹é‡è¦çš„æ¨¡å‹/æƒé‡æ–‡ä»¶è¿›è¡ŒåŠ å¯†**

   ```shell
   mkdir -p /usr/local/ev_sdk/model_encryption/
   cd /usr/local/ev_sdk/model_encryption/
   /usr/local/3rd/ev_encrypt_module/bin/encrypt_tool /usr/local/ev_sdk/model/yolov3-tiny.cfg
   ```

   æ‰§è¡ŒæˆåŠŸåä¼šç”ŸæˆåŠ å¯†åçš„æ–‡ä»¶`model_str.hpp`ï¼Œ`encrypt_tool`ç¨‹åºæ”¯æŒåœ¨åŠ å¯†æ¨¡å‹æ—¶æŒ‡å®šä¸€ä¸ªæ··æ·†å­—ç¬¦ä¸²ï¼Œå…·ä½“æ–¹æ³•è¯·æ‰§è¡Œ`encrypt_tool`å‚è€ƒå¸®åŠ©æ–‡æ¡£ã€‚å°†å¤´æ–‡ä»¶ç§»åŠ¨åˆ°ä»£ç åŒº

   ```shell
   mv /usr/local/ev_sdk/model_encryption/model_str.hpp /usr/local/ev_sdk/include
   ```

   è¿™ä¸ªåŠ å¯†åçš„æ¨¡å‹å°†è¢«**ç¡¬ç¼–ç **åˆ°`libji.so`ã€‚

2. åœ¨`ji_create_predictor(int)`çš„æ¥å£å®ç°ä¸­ï¼Œæ·»åŠ æ¨¡å‹è§£å¯†çš„åŠŸèƒ½ã€‚

   **æ³¨ï¼šç¤ºä¾‹ä»£ç `ji.cpp`é‡Œé¢æä¾›äº†è§£å¯†çš„æ–¹æ³•ï¼Œå¯¹äºåŠ å¯†æ–‡æœ¬ç±»å‹çš„æ¨¡å‹æ–‡ä»¶çš„åœºæ™¯å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€æ›´æ”¹ã€‚**
   
   ```c++
   // åˆ›å»ºè§£å¯†å¥æŸ„
   void *h = CreateEncryptor(model_str.c_str(), model_str.size(), key.c_str());
   // è·å–è§£å¯†åçš„å­—ç¬¦ä¸²
   int fileLen = 0;
   model_struct_str = (char *) FetchBuffer(h, fileLen);
   // è·å–è§£å¯†åçš„æ–‡ä»¶å¥æŸ„
   // file *file = (file *) FetchFile(h);
   DestroyEncrtptor(h);
   ```
   
   æ¨¡å‹è§£å¯†çš„è¯¦ç»†æ¥å£å‡½æ•°è¯·å‚è€ƒå…¶å¤´æ–‡ä»¶[encrypt_wrapper.h](3rd/ev_encrypt_module/include/encrypt_wrapper.hpp)

#### å®ç°`ji.h`ä¸­çš„æ¥å£

`ji.h`ä¸­å®šä¹‰äº†æ‰€æœ‰`EV_SDK`è§„èŒƒçš„æ¥å£ï¼Œè¯¦ç»†çš„æ¥å£å®šä¹‰å’Œå®ç°ç¤ºä¾‹ï¼Œè¯·å‚è€ƒå¤´æ–‡ä»¶[ji.h](include/ji.h)å’Œç¤ºä¾‹ä»£ç [ji.cpp](src/ji.cpp)ã€‚

å°†ä»£ç ç¼–è¯‘æˆ`libji.so`

```shell
mkdir -p /usr/local/ev_sdk/build
cd /usr/local/ev_sdk/build
cmake ..
make install
```

ç¼–è¯‘å®Œæˆåï¼Œå°†åœ¨`/usr/local/ev_sdk/lib`ä¸‹ç”Ÿæˆ`libji.so`å’Œå…¶ä»–ä¾èµ–çš„åº“ã€‚

#### æµ‹è¯•æ¥å£åŠŸèƒ½

æµ‹è¯•`libji.so`çš„æˆæƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œä»¥åŠ`ji.h`çš„æ¥å£è§„èŒƒ

1. ä½¿ç”¨`EV_SDK`æä¾›çš„ç¨‹åº`oneKeyTest.sh`ä¸€é”®ç”Ÿæˆæˆæƒæ–‡ä»¶

   ```shell
   bash /usr/local/ev_sdk/3rd/license/bin/oneKeyTest.sh
   ```

   `oneKeyTest.sh`ä¼šæ‰§è¡Œï¼š

   - æ£€æŸ¥`authorization/pubKey.pem`å’Œ`authorization/privateKey.pem`çš„æœ‰æ•ˆæ€§ï¼›

   - ç”Ÿæˆç¡¬ä»¶å‚è€ƒç æ–‡ä»¶`authorization/reference.txt`å’Œæˆæƒæ–‡ä»¶`authorization/license.txt`ã€‚

2. æ£€æŸ¥æˆæƒåŠŸèƒ½å’Œ`ji.h`çš„æ¥å£è§„èŒƒæ€§

   `EV_SDK`ä»£ç ä¸­æä¾›äº†æµ‹è¯•æ‰€æœ‰æ¥å£çš„æµ‹è¯•ç¨‹åºï¼Œ**ç¼–è¯‘å¹¶å®‰è£…**`libji.so`ä¹‹åï¼Œä¼šåœ¨`/usr/local/ev_sdk/bin`ä¸‹ç”Ÿæˆ`test-ji-api`å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ`test-ji-api`ç”¨äºæµ‹è¯•`ji.h`çš„æ¥å£å®ç°æ˜¯å¦æ­£å¸¸ï¼Œä¾‹å¦‚ï¼Œæµ‹è¯•`ji_calc_frame`æ¥å£ä»¥åŠæˆæƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼š

   ```shell
   /usr/local/ev_sdk/bin/test-ji-api -f ji_calc_frame \
   -i /usr/local/ev_sdk/data/dog.jpg \
   -o /tmp/output.jpg \
   -l /usr/local/ev_sdk/authorization/license.txt \
   -a '{"roi":["POLYGON((0.2 0.2,0.6 0.1,0.8 0.7,0.4 0.9,0 0.8,0.2 0.2))"]}'
   ```
   
   æ¥å£æµ‹è¯•ç¨‹åºçš„è¯¦ç»†åŠŸèƒ½è¯·æŸ¥é˜…`test-ji-api --help`çš„å¸®åŠ©æ–‡æ¡£åŠå…¶ä»£ç [test.cpp](test/src/test.cpp)

## å“ªäº›å†…å®¹å¿…é¡»å®Œæˆæ‰èƒ½é€šè¿‡æµ‹è¯•ï¼Ÿ
#### æŒ‰ç…§éœ€æ±‚å®ç°æ¥å£ï¼ˆç”±é¡¹ç›®ç»ç†å‘ŠçŸ¥ï¼‰
1. `ji_calc_frame` ï¼Œç”¨äºå®æ—¶è§†é¢‘æµåˆ†æ
2. `ji_calc_buffer` ï¼Œç”¨äºåˆ†æå›¾ç‰‡`buffer`
3. `ji_calc_file` ï¼Œç”¨äºåˆ†æå›¾ç‰‡æ–‡ä»¶
4. `ji_calc_video_file` ï¼šç”¨äºæå¸‚å¹³å°æµ‹è¯•ç»„æµ‹è¯•å’Œå¼€å‘è€…è‡ªæµ‹è§†é¢‘æ–‡ä»¶

#### è§„èŒƒè¦æ±‚

è§„èŒƒæµ‹è¯•å¤§éƒ¨åˆ†å†…å®¹ä¾èµ–äºå†…ç½®çš„`/usr/local/ev_sdk/test`ä¸‹é¢çš„ä»£ç ï¼Œè¿™ä¸ªæµ‹è¯•ç¨‹åºä¼šé“¾æ¥`/usr/local/ev_sdk/lib/libji.so`åº“ï¼Œ`EV_SDK`å°è£…å®Œæˆæäº¤åï¼Œæå¸‚æ–¹ä¼šä½¿ç”¨`test-ji-api`ç¨‹åºæµ‹è¯•`ji.h`ä¸­çš„æ‰€æœ‰æ¥å£ã€‚æµ‹è¯•ç¨‹åºä¸`EV_SDK`çš„å®ç°æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥è¯·**è¯·ä¸è¦ä¿®æ”¹`/usr/local/ev_sdk/test`ç›®å½•ä¸‹çš„ä»£ç ï¼ï¼ï¼**

1. æ¥å£åŠŸèƒ½è¦æ±‚
  
   - ç¡®å®š`test-ji-api`èƒ½å¤Ÿæ­£å¸¸ç¼–è¯‘ï¼Œå¹¶ä¸”å°†`test-ji-api`å’Œ`license.txt`ç§»åŠ¨åˆ°ä»»æ„ç›®å½•ï¼Œéƒ½éœ€è¦èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼›
   
   - åœ¨æäº¤ç®—æ³•ä¹‹å‰ï¼Œè¯·è‡ªè¡Œé€šè¿‡`/usr/local/ev_sdk/bin/test-ji-api`æµ‹è¯•æ¥å£åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼›
   
   - æœªå®ç°çš„æ¥å£éœ€è¦è¿”å›`JISDK_RET_UNUSED`ï¼›
   
   - å®ç°çš„æ¥å£ï¼Œå¦‚æœä¼ å…¥å‚æ•°å¼‚å¸¸æ—¶ï¼Œéœ€è¦è¿”å›`JISDK_RET_INVALIDPARAMS`ï¼›
   
   - å¯¹äºå®ç°å¤šä¸ªæ¥å£çš„æƒ…å†µï¼Œè¯·ç¡®ä¿æ¯ä¸ªæ¥å£å¯¹åŒæ ·çš„è¾“å…¥æ•°æ®ä¿æŒä¸€è‡´çš„ç®—æ³•åˆ†æç»“æœï¼Œæ¯”å¦‚`ji_calc_frame`å’Œ`ji_calc_file`ä¸¤ä¸ªæ¥å£å¯¹äºåŒæ ·çš„è¾“å…¥å›¾ç‰‡æ•°æ®ï¼Œåº”è¯¥ä¿æŒä¸€æ ·çš„åˆ†æç»“æœï¼›
   
   - è¾“å…¥å›¾ç‰‡å’Œè¾“å‡ºå›¾ç‰‡çš„å°ºå¯¸åº”ä¿æŒä¸€è‡´ï¼›
   
   - å¯¹äºæ¥å£ä¸­ä¼ å…¥çš„å‚æ•°`args`ï¼ˆå¦‚ï¼Œ`ji_calc_frame(void *, const JI_CV_FRAME *, const char *args, JI_CV_FRAME *, JI_EVENT *)`ä¸­ä¸­`args`ï¼‰ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œç®—æ³•å®ç°éœ€è¦æ”¯æŒ`args`å®é™…ä¼ å…¥çš„å‚æ•°ã€‚
   
     ä¾‹å¦‚ï¼Œå¦‚æœé¡¹ç›®éœ€è¦æ”¯æŒåœ¨`args`ä¸­ä¼ å…¥`roi`å‚æ•°ï¼Œä½¿å¾—ç®—æ³•åªå¯¹`roi`åŒºåŸŸè¿›è¡Œåˆ†æï¼Œé‚£ä¹ˆ**ç®—æ³•å†…éƒ¨å¿…é¡»å®ç°åªé’ˆå¯¹`roi`åŒºåŸŸè¿›è¡Œåˆ†æçš„åŠŸèƒ½**ï¼›
   
   - å¯¹äºæ¥å£`ji_calc_video`æ¥å£ï¼Œå…¶ä¿å­˜çš„`json`æ–‡ä»¶æ ¼å¼å¿…é¡»ä¸`ji_calc_frame`ã€`ji_calc_file`ã€`ji_calc_buffer`ä¸­çš„`JI_EVENT.json`æ ¼å¼ä¿æŒä¸€è‡´ï¼›
   
   - é€šå¸¸è¾“å‡ºå›¾ç‰‡ä¸­éœ€è¦ç”»`roi`åŒºåŸŸã€ç›®æ ‡æ¡†ç­‰ï¼Œè¯·ç¡®ä¿è¿™ä¸€åŠŸèƒ½æ­£å¸¸ï¼ŒåŒ…æ‹¬ä½†ä¸ä»…é™äºï¼š
   
     - `args`ä¸­è¾“å…¥çš„`roi`éœ€è¦æ”¯æŒå¤šè¾¹å½¢
     - ç®—æ³•é»˜è®¤åˆ†æåŒºåŸŸå¿…é¡»æ˜¯å…¨å°ºå¯¸å›¾ï¼Œå¦‚å½“`roi`ä¼ å…¥ä¸ºç©ºæ—¶ï¼Œç®—æ³•å¯¹æ•´å¼ å›¾è¿›è¡Œåˆ†æï¼›
     
   - ä¸ºäº†ä¿è¯å¤šä¸ªç®—æ³•æ˜¾ç¤ºæ•ˆæœçš„ä¸€è‡´æ€§ï¼Œä¸ç”»æ¡†ç›¸å…³çš„åŠŸèƒ½å¿…é¡»ä¼˜å…ˆä½¿ç”¨`ji_utils.hpp.h`ä¸­æä¾›çš„å·¥å…·å‡½æ•°ï¼›
   
   > 1. ` test-ji-api`çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒä¸Šé¢çš„ä½¿ç”¨ç¤ºä¾‹ä»¥åŠè¿è¡Œ`test-ji-api --help`ï¼›
   > 2. ä»¥ä¸Šè¦æ±‚åœ¨ç¤ºä¾‹ç¨‹åº`ji.cpp`ä¸­æœ‰å®ç°ï¼›
   
2. ä¸šåŠ¡é€»è¾‘è¦æ±‚

   é’ˆå¯¹éœ€è¦æŠ¥è­¦çš„éœ€æ±‚ï¼Œç®—æ³•å¿…é¡»æŒ‰ç…§ä»¥ä¸‹è§„èŒƒè¾“å‡ºç»“æœï¼š
   * æŠ¥è­¦æ—¶è¾“å‡ºï¼š`JI_EVENT.code=JISDK_CODE_ALARM`ï¼Œ`JI_EVENT.json`å†…éƒ¨å¡«å……`"alert_flag"=1`ï¼›
   * æœªæŠ¥è­¦æ—¶è¾“å‡ºï¼š`JI_EVENT.code=JISDK_CODE_NORMAL`ï¼Œ`JI_EVENT.json`å†…éƒ¨å¡«å……`"alert_flag"=0`ï¼›
   * å¤„ç†å¤±è´¥çš„æ¥å£è¿”å›`JI_EVENT.code=JISDK_CODE_FAILED`

   * ç®—æ³•è¾“å‡ºçš„`json`æ•°æ®å¿…é¡»ä¸é¡¹ç›®éœ€æ±‚ä¿æŒä¸€è‡´ï¼›

3. æˆæƒåŠŸèƒ½è¦æ±‚

   éœ€è¦å®ç°æˆæƒåŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨æ¥å£ï¼ˆæ¯”å¦‚`ji_calc_frame`ï¼‰æ—¶ï¼Œå¦‚æœæˆæƒæ²¡æœ‰é€šè¿‡ï¼Œå¿…é¡»è¿”å›`JISDK_RET_UNAUTHORIZED`ã€‚

   > **æ³¨ï¼šæˆæƒåŠŸèƒ½å·²ç»åœ¨ç¤ºä¾‹ä»£ç å®ç°ï¼ŒåŸºæœ¬ä¸éœ€è¦ä¿®æ”¹**

4. ç®—æ³•é…ç½®é€‰é¡¹è¦æ±‚

   - `EV_SDK`çš„å®ç°éœ€è¦ä½¿ç”¨æ ‡å‡†[JSON](https://www.json.cn/wiki.html)æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰ç®—æ³•ä¸`SDK`å¯é…ç½®å‚æ•°**å¿…é¡»**å­˜æ”¾åœ¨ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ï¼š`/usr/local/ev_sdk/config/algo_config.json`ä¸­ï¼›
   - é…ç½®æ–‡ä»¶ä¸­å¿…é¡»å®ç°çš„å‚æ•°é¡¹ï¼š
     - `draw_roi_area`ï¼š`true`æˆ–è€…`false`ï¼Œæ˜¯å¦åœ¨è¾“å‡ºå›¾ä¸­ç»˜åˆ¶`roi`åˆ†æåŒºåŸŸï¼›
     - `roi_line_thickness`ï¼šROIåŒºåŸŸçš„è¾¹æ¡†ç²—ç»†ï¼›
     - `roi_fill`ï¼šæ˜¯å¦ä½¿ç”¨é¢œè‰²å¡«å……ROIåŒºåŸŸï¼›
     - `roi_color`ï¼š`roi`æ¡†çš„é¢œè‰²ï¼Œä»¥BGRAè¡¨ç¤ºçš„æ•°ç»„ï¼Œå¦‚`[0, 255, 0, 0]`ï¼Œå‚è€ƒ[model/README.md](model/README.md)ï¼›
     - `roi`ï¼šé’ˆå¯¹å›¾ç‰‡çš„æ„Ÿå…´è¶£åŒºåŸŸè¿›è¡Œåˆ†æï¼Œå¦‚æœæ²¡æœ‰æ­¤å‚æ•°æˆ–è€…æ­¤å‚æ•°è§£æé”™è¯¯ï¼Œåˆ™roié»˜è®¤å€¼ä¸ºæ•´å¼ å›¾ç‰‡åŒºåŸŸï¼›
     - `thresh`ï¼šç®—æ³•é˜ˆå€¼ï¼Œéœ€è¦æœ‰å¯ä»¥è°ƒæ•´ç®—æ³•çµæ•åº¦ã€å¬å›ç‡ã€ç²¾ç¡®ç‡çš„é˜ˆå€¼å‚æ•°ï¼Œå¦‚æœç®—æ³•é…ç½®é¡¹æœ‰å¤šä¸ªå‚æ•°ï¼Œè¯·è‡ªè¡Œæ‰©å±•ï¼Œæ‰€æœ‰ä¸ç®—æ³•æ•ˆæœç›¸å…³å¹¶ä¸”å¯ä»¥å˜åŠ¨çš„å‚æ•°**å¿…é¡»**åœ¨`/usr/local/ev_sdk/config/README.md`ä¸­æä¾›è¯¦ç»†çš„é…ç½®æ–¹æ³•å’Œè¯´æ˜ï¼ˆåŒ…æ‹¬ç±»å‹ã€å–å€¼èŒƒå›´ã€å»ºè®®å€¼ã€é»˜è®¤å€¼ã€å¯¹ç®—æ³•æ•ˆæœçš„å½±å“ç­‰ï¼‰ï¼›
     - `draw_result`ï¼š`true`æˆ–è€…`false`ï¼Œæ˜¯å¦ç»˜åˆ¶åˆ†æç»“æœï¼Œæ¯”å¦‚ç¤ºä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœæ£€æµ‹åˆ°ç‹—ï¼Œæ˜¯å¦å°†æ£€æµ‹æ¡†å’Œæ–‡å­—ç”»åœ¨è¾“å‡ºå›¾ä¸­ï¼›
     - `draw_confidence`ï¼š`true`æˆ–è€…`false`ï¼Œæ˜¯å¦å°†ç½®ä¿¡åº¦ç”»åœ¨æ£€æµ‹æ¡†é¡¶éƒ¨ï¼Œå°æ•°ç‚¹åä¿ç•™ä¸¤ä½ï¼›
     - `language`ï¼šæ‰€æ˜¾ç¤ºæ–‡å­—çš„è¯­è¨€ï¼Œéœ€è¦æ”¯æŒ`en`å’Œ`zh`ä¸¤ç§é€‰é¡¹ï¼Œåˆ†åˆ«å¯¹åº”è‹±æ–‡å’Œä¸­æ–‡ï¼›
     - æ‰€æœ‰`json`å†…çš„é”®åç§°å¿…é¡»æ˜¯å°å†™å­—æ¯ï¼Œå¹¶ä¸”å•è¯é—´ä»¥ä¸‹åˆ’çº¿åˆ†éš”ï¼Œå¦‚ä¸Šé¢å‡ ä¸ªç¤ºä¾‹ã€‚
   - **å¿…é¡»æ”¯æŒå‚æ•°å®æ—¶æ›´æ–°**ã€‚æ‰€æœ‰`/usr/local/ev_sdk/config/algo_config.json`å†…çš„å¯é…ç½®å‚æ•°å¿…é¡»æ”¯æŒèƒ½å¤Ÿåœ¨è°ƒç”¨`ji_calc_frame`ã€`ji_calc_buffer`ã€`ji_calc_file`ã€`ji_calc_video_file`å››ä¸ªæ¥å£æ—¶ï¼Œè¿›è¡Œå®æ—¶æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯å¿…é¡»è¦åœ¨`ji_calc_*`ç­‰æ¥å£çš„`args`å‚æ•°ä¸­ï¼ŒåŠ å…¥è¿™äº›å¯é…ç½®é¡¹ã€‚

5. ç®—æ³•è¾“å‡ºè§„èŒƒè¦æ±‚

   ç®—æ³•è¾“å‡ºç»“æœï¼Œå³`JI_EVENT.json`å¿…é¡»æ˜¯ä½¿ç”¨`json`æ ¼å¼å¡«å……çš„å­—ç¬¦ä¸²ï¼Œ`json`å­—ç¬¦ä¸²å†…æ‰€æœ‰çš„**é”®åç§°**å¿…é¡»æ˜¯å°å†™å­—æ¯ï¼Œå¹¶ä¸”å•è¯ä¹‹é—´ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”ï¼Œå¦‚`alert_flag`ï¼›

6. æ–‡ä»¶ç»“æ„è§„èŒƒè¦æ±‚

   * æˆæƒåŠŸèƒ½ç”Ÿæˆçš„å…¬ç§é’¥å¿…é¡»æ”¾åœ¨`/usr/local/ev_sdk/bin` ï¼Œä¸”ä¸€æ¬¡ç”Ÿæˆåï¼Œè¯·å‹¿å†æ¬¡æ›´æ–°å…¬ç§é’¥ï¼ˆæå¸‚æ–¹ä¼šä¿å­˜ç¬¬ä¸€ç‰ˆçš„ç§é’¥ï¼‰ï¼Œå¦‚æœåœ¨åç»­æ›´æ–°ä¸­ï¼Œé‡æ–°ç”Ÿæˆäº†å…¬ç§é’¥ï¼Œä¼šå¯¼è‡´å…¬ç§é’¥ä¸åŒ¹é…ï¼›
   * ä¸æ¨¡å‹ç›¸å…³çš„æ–‡ä»¶å¿…é¡»å­˜æ”¾åœ¨`/usr/local/ev_sdk/model`ç›®å½•ä¸‹ï¼Œä¾‹å¦‚æƒé‡æ–‡ä»¶ã€ç›®æ ‡æ£€æµ‹é€šå¸¸éœ€è¦çš„åç§°æ–‡ä»¶`coco.names`ç­‰ã€‚
   * æœ€ç»ˆç¼–è¯‘ç”Ÿæˆçš„`libji.so`å¿…é¡»è‡ªè¡Œé“¾æ¥å¿…è¦çš„åº“ï¼Œ`test-ji-api`ä¸ä¼šé“¾æ¥é™¤`/usr/local/ev_sdk/lib/libji.so`ä»¥å¤–çš„ç®—æ³•ä¾èµ–åº“ï¼›
   * å¦‚æœ`libji.so`ä¾èµ–äº†ç³»ç»ŸåŠ¨æ€åº“æœç´¢è·¯å¾„ï¼ˆå¦‚`/usr/lib`ï¼Œ`/lib`ç­‰ï¼‰ä»¥å¤–çš„åº“ï¼Œå¿…é¡»å°†å…¶å®‰è£…åˆ°`/usr/local/ev_sdk/lib`ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨`ldd /usr/local/ev_sdk/lib/libji.so`æŸ¥çœ‹`libji.so`æ˜¯å¦æ­£ç¡®é“¾æ¥äº†æ‰€æœ‰çš„ä¾èµ–åº“ã€‚
   * **æˆæƒæ–‡ä»¶ä½ç½®**
     * è¯·åŠ¡å¿…å°†ç”Ÿæˆçš„ç§é’¥`privateKey.pem`å’Œå…¬é’¥`publicKey.pem`æ”¾åˆ°`/usr/local/ev_sdk/authorization`ä¸‹ã€‚**å¹¶è¯·è‡ªè¡Œä¿å­˜ä¸€ä»½ï¼Œåç»­ç®—æ³•è¿­ä»£è¿‡ç¨‹éƒ½ä¼šä½¿ç”¨ç¬¬ä¸€æ¬¡æäº¤çš„å…¬ç§é’¥ï¼Œä¸èƒ½é‡æ–°ç”Ÿæˆ**ã€‚


## FAQ

### å¦‚ä½•ä½¿ç”¨æ¥å£ä¸­çš„`args`ï¼Ÿ

é€šå¸¸ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¤–éƒ¨éœ€è¦å°†å¤šç§å‚æ•°ï¼ˆä¾‹å¦‚`ROI`ï¼‰ä¼ å…¥åˆ°ç®—æ³•ï¼Œä½¿å¾—ç®—æ³•å¯ä»¥æ ¹æ®è¿™äº›å‚æ•°æ¥æ”¹å˜å¤„ç†é€»è¾‘ã€‚`EV_SDK`æ¥å£ï¼ˆå¦‚`int ji_calc_frame(void *, const JI_CV_FRAME *, const char *args, JI_CV_FRAME *, JI_EVENT *)`ä¸­çš„`args`å‚æ•°é€šå¸¸ç”±å¼€å‘è€…è‡ªè¡Œå®šä¹‰å’Œè§£æï¼Œä½†åªèƒ½ä½¿ç”¨[JSON](https://www.json.cn/wiki.html)æ ¼å¼ã€‚æ ¼å¼æ ·ä¾‹ï¼š

```shell
{
    "cid": "1000",
    "roi": [
        "POLYGON((0.0480.357,0.1660.0725,0.3930.0075,0.3920.202,0.2420.375))",
        "POLYGON((0.5130.232,0.790.1075,0.9280.102,0.9530.64,0.7590.89,0.510.245))",
        "POLYGON((0.1150.497,0.5920.82,0.5810.917,0.140.932))"
    ],
    "cross_line": ["LINESTRING(0.070.21,0.360.245,0.580.16,0.970.27)"],
    "point": [
            "POINT(0.38 0.10)",
            "POINT(0.47 0.41)"
    ]
}
```

ä¾‹å¦‚å½“ç®—æ³•æ”¯æŒè¾“å…¥`ROI`å‚æ•°æ—¶ï¼Œé‚£ä¹ˆå¼€å‘è€…éœ€è¦åœ¨`EV_SDK`çš„æ¥å£å®ç°ä¸­è§£æä¸Šé¢ç¤ºä¾‹ä¸­`roi`è¿™ä¸€å€¼ï¼Œæå–å…¶ä¸­çš„`ROI`å‚æ•°ï¼Œå¹¶ä½¿ç”¨`WKTParser`å¯¹å…¶è¿›è¡Œè§£æï¼Œåº”ç”¨åˆ°è‡ªå·±çš„ç®—æ³•é€»è¾‘ä¸­ã€‚

### å¦‚ä½•åœ¨`algo_config.json`å†…æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰é…ç½®é¡¹ï¼Ÿ

å‡å®šéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ç®—æ³•é˜ˆå€¼å‚æ•°`nms_thresh`ï¼Œåˆ™éœ€è¦ï¼š

1. åœ¨`algo_config.json`ä¸­åŠ å…¥é»˜è®¤é…ç½®å‚æ•°ï¼š

   ```json
   "nms_thresh": 0.4
   ```

2. åœ¨`Configuration.hpp`ä¸­çš„`Configuration`ç»“æ„ä½“ä¸­æ·»åŠ è¿™ä¸€å‚æ•°å¯¹åº”çš„å˜é‡ï¼š

   ```c++
   float nmsThresh = 0.4;
   ```

3. åœ¨`Configuration.hpp`çš„`Configuration.parseAndUpdateArgs`æ–¹æ³•ä¸­æ·»åŠ å¯¹è¯¥å‚æ•°çš„è§£æä»£ç ï¼š

   ```c++
   cJSON *nmsThreshObj = cJSON_GetObjectItem(confObj, "nms_thresh");
   if (nmsThreshObj != nullptr && nmsThreshObj->type == cJSON_Number) {
   	nmsThresh = nmsThreshObj->valuedouble;     // è·å–é»˜è®¤çš„é˜ˆå€¼
     algoConfig.thresh = newThresh;
   }
   ```

### ä¸ºä»€ä¹ˆä¸èƒ½ä¸”ä¸éœ€è¦ä¿®æ”¹`/usr/local/ev_sdk/test`ä¸‹çš„ä»£ç ï¼Ÿ

1. `/usr/local/ev_sdk/test`ä¸‹çš„ä»£ç æ˜¯ç”¨äºæµ‹è¯•`ji.h`æ¥å£åœ¨`libji.so`ä¸­æ˜¯å¦è¢«æ­£ç¡®å®ç°ï¼Œè¿™ä¸€æµ‹è¯•ç¨‹åºä¸`EV_SDK`çš„å®ç°æ— å…³ï¼Œä¸”æ˜¯æå¸‚æ–¹çš„æµ‹è¯•æ ‡å‡†ï¼Œä¸èƒ½å˜åŠ¨ï¼›
2. ç¼–è¯‘å`test-ji-api`ç¨‹åºåªä¼šä¾èµ–`libji.so`ï¼Œå¦‚æœ`test-ji-api`æ— æ³•æ­£å¸¸è¿è¡Œï¼Œå¾ˆå¯èƒ½æ˜¯`libji.so`æ²¡æœ‰æŒ‰ç…§è§„èŒƒè¿›è¡Œå°è£…ï¼›

### ä¸ºä»€ä¹ˆè¿è¡Œ`test-ji-api`æ—¶ï¼Œä¼šæç¤ºæ‰¾ä¸åˆ°é“¾æ¥åº“ï¼Ÿ

ç”±äº`test-ji-api`å¯¹äºç®—æ³•è€Œè¨€ï¼Œåªé“¾æ¥äº†`/usr/local/ev_sdk/lib/libji.so`åº“ï¼Œå¦‚æœ`test-ji-api`è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰¾ä¸åˆ°æŸäº›åº“ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½æ˜¯`libji.so`ä¾èµ–çš„æŸäº›åº“æ‰¾ä¸åˆ°äº†ã€‚æ­¤æ—¶

1. å¯ä»¥ä½¿ç”¨`ldd /usr/local/ev_sdk/lib/libji.so`æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é“¾æ¥åº“éƒ½å¯ä»¥æ‰¾åˆ°ï¼›
2. è¯·æŒ‰ç…§è§„èŒƒå°†ç³»ç»ŸåŠ¨æ€åº“æœç´¢è·¯å¾„ä»¥å¤–çš„åº“æ”¾åœ¨`/usr/local/ev_sdk/lib`ç›®å½•ä¸‹ã€‚

### å¦‚ä½•ä½¿ç”¨`test-ji-api`è¿›è¡Œæµ‹è¯•ï¼Ÿ

1. è¾“å…¥å•å¼ å›¾ç‰‡å’Œæˆæƒæ–‡ä»¶ï¼Œå¹¶è°ƒç”¨`ji_calc_frame`æ¥å£ï¼š

   ```shell
   ./test-ji-api -f ji_calc_frame -i /path/to/test.jpg -l /path/to/license.txt
   ```

2. è¾“å…¥`json`æ ¼å¼çš„`roi`å‚æ•°åˆ°`args`å‚æ•°ï¼š

   ```shell
   ./test-ji-api \
   -f ji_calc_frame \
   -i /path/to/test.jpg \
   -l /path/to/license.txt \
   -a '{"roi":["POLYGON((0.21666666666666667 0.255,0.6924242424242424 0.1375,0.8833333333333333 0.72,0.4106060606060606 0.965,0.048484848484848485 0.82,0.2196969696969697 0.2575))"]}'
   ```

3. ä¿å­˜è¾“å‡ºå›¾ç‰‡ï¼š

   ```shell
   ./test-ji-api -f ji_calc_frame -i /path/to/test.jpg -l /path/to/license.txt -o /path/to/out.jpg
   ```

æ›´å¤šé€‰é¡¹ï¼Œè¯·å‚è€ƒ`test-ji-api --help`
